# ARCHITECTURE.md

## 概要

dps-claudecode.vimは、denops.vimフレームワークを使用してClaude
CodeをVim/Neovimに統合するプラグインです。

## システムアーキテクチャ

```
┌─────────────────┐     ┌──────────────────┐
│   Vim/Neovim    │     │  Claude Code API │
│                 │     │                  │
│  ┌───────────┐  │     └──────────────────┘
│  │ Vim Script│  │              ▲
│  └───────────┘  │              │
│        │        │              │
│        ▼        │              │
│  ┌───────────┐  │     ┌────────┴─────────┐
│  │  Denops   │  │     │  Claude Code SDK │
│  │           │  │     │ (@anthropic-ai/  │
│  └───────────┘  │     │  claude-code)    │
│        │        │     └──────────────────┘
│        ▼        │              ▲
│  ┌───────────┐  │              │
│  │TypeScript │◄─┼──────────────┘
│  │   (Deno)  │  │
│  └───────────┘  │
└─────────────────┘
```

## コンポーネント構成

### 1. Vimインターフェース層

- **autoload/claudecode.vim**: 主要なVim関数とコマンドの定義
- **autoload/claudecode/buffer.vim**: プロンプトバッファの管理
- **plugin/claudecode.vim**: プラグインの初期化とグローバルコマンドの登録

### 2. Denops層

- **denops/claudecode/app.ts**: メインアプリケーションロジック
  - Denops APIとの通信
  - Claude Code SDKの初期化と管理
  - コマンドとイベントのハンドリング

### 3. Claude Code統合

- Claude Code SDKを使用したAPI通信
- ストリーミングレスポンスの処理
- エラーハンドリングとリトライロジック

## 主要機能の実装

### プロンプトバッファ

ユーザーとClaude Codeの対話的なインターフェースを提供：

1. 専用バッファの作成と管理
1. 入力と出力の分離表示
1. 非同期レスポンスの処理
1. コンテキストの保持

### IDE連携機能

claudecode.nvimの実装を参考に：

1. カレントファイルのコンテキスト送信
1. 選択範囲のコード送信
1. プロジェクト構造の理解
1. コード補完の提供（将来実装）

## データフロー

1. **ユーザー入力** → Vimコマンド/バッファ
1. **Vim Script** → Denops RPC呼び出し
1. **TypeScript処理** → リクエストの構築
1. **Claude Code SDK** → API通信
1. **レスポンス処理** → ストリーミング/バッチ
1. **UI更新** → バッファへの出力

## 状態管理

すべての状態はTypeScript側で一元管理されており、Vim
Script側は必要に応じてTypeScriptに問い合わせを行います：

### TypeScript側（app.ts）

- `sessions: Map<string, Session>` - すべてのセッション情報
- `currentSessionId: string | null` - 現在のアクティブセッションID

### Vim Script側

- 状態は保持せず、必要時にTypeScriptから取得
- `denops#request()` で同期的に状態を問い合わせ
- エラーハンドリングを適切に実装

### 利点

- Single Source of Truth（真実の単一情報源）の原則に従う
- 状態の同期問題を回避
- デバッグとメンテナンスが容易
- プラグインのリロード時も一貫性を保持

## 非同期処理

Denopsの非同期機能を活用：

- Promise/async-awaitパターンの使用
- ストリーミングレスポンスの逐次処理
- UIのブロッキングを避ける設計

## エラーハンドリング

多層的なエラー処理：

1. ネットワークエラー
1. API制限/レート制限
1. 認証エラー
1. パース/バリデーションエラー

## 設定管理

- グローバル変数による設定
- ローカル設定のオーバーライド
- 環境変数のサポート

## 将来の拡張計画

1. **MCPサーバー統合**: より高度なツール連携
1. **カスタムプロンプト**: ユーザー定義のテンプレート
1. **コード生成機能**: ファイル作成/編集の自動化
1. **デバッグサポート**: エラー解析と修正提案
